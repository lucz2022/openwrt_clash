name: Mirror OpenClash + Mihomo (to my Releases)

on:
  workflow_dispatch:
  schedule:
    # 每月 1 号 03:10 UTC（新加坡/中国时间 +8 约 11:10）
    - cron: "10 3 1 * *"

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl jq gzip coreutils

      # 1) 拉 OpenClash 的 luci-app-openclash_*_all.ipk
      - name: Fetch latest OpenClash ipk (all)
        id: openclash
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/vernesong/OpenClash/releases"
          url="$(
            curl -sL "$api" | jq -r '
              .[0].assets[]
              | select(.name|test("^luci-app-openclash_.*_all\\.ipk$"))
              | .browser_download_url
            ' | head -n1 | tr -d '\r\n'
          )"

          echo "openclash url=[$url]"

          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "ERROR: cannot find luci-app-openclash_*_all.ipk in latest release."
            curl -sL "$api" | jq -r '.[0].assets[].name'
            exit 1
          fi

          name="$(basename "$url")"
          echo "OPENCLASH_URL=$url" >> "$GITHUB_ENV"
          echo "OPENCLASH_NAME=$name" >> "$GITHUB_ENV"

      # 2) 拉 Mihomo core（优先 compatible 的 .gz），并解压成可执行文件 dist/mihomo
      - name: Fetch latest Mihomo core (linux amd64 compatible gz) and unpack
        id: mihomo
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          url="$(
            curl -sL "$api" | jq -r '
              .assets[].browser_download_url
              | select(test("mihomo-linux-amd64-compatible-";"i"))
              | select(endswith(".gz"))
            ' | head -n1 | tr -d '\r\n'
          )"

          echo "mihomo url=[$url]"

          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "ERROR: cannot find mihomo-linux-amd64-compatible-*.gz in latest release."
            echo "Available assets:"
            curl -sL "$api" | jq -r '.assets[].name'
            exit 1
          fi

          echo "MIHOMO_GZ_URL=$url" >> "$GITHUB_ENV"
          echo "MIHOMO_GZ_NAME=$(basename "$url")" >> "$GITHUB_ENV"

      - name: Download assets + checksums
        run: |
          set -euo pipefail
          mkdir -p dist

          # OpenClash ipk
          curl -fL --retry 5 --retry-delay 2 "$OPENCLASH_URL" -o "dist/$OPENCLASH_NAME"

          # Mihomo core (gz -> binary)
          curl -fL --retry 5 --retry-delay 2 "$MIHOMO_GZ_URL" -o "dist/mihomo.gz"
          gzip -dc "dist/mihomo.gz" > "dist/mihomo"
          chmod +x "dist/mihomo"

          # checksum
          (cd dist && sha256sum * > SHA256SUMS.txt)

          ls -lah dist

      # 3) 发布到你自己的 Releases（每次跑一个新 Release，方便回滚）
      - name: Create Release and upload files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mirror-${{ github.run_id }}
          name: Mirror OpenClash + Mihomo (run ${{ github.run_id }})
          body: |
            Mirrored from upstream:
            - OpenClash: ${{ env.OPENCLASH_NAME }}
            - Mihomo: ${{ env.MIHOMO_GZ_NAME }} (unpacked to dist/mihomo)

            Files include SHA256SUMS.txt for integrity verification.
          files: |
            dist/*
