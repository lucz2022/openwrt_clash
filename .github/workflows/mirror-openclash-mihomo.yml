name: Mirror OpenClash + Mihomo (fixed + versioned)

on:
  workflow_dispatch:
  schedule:
    # Monthly on day 1 at 03:10 UTC (~11:10 UTC+8)
    - cron: "10 3 1 * *"

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl jq gzip coreutils

      - name: Fetch latest OpenClash (tag + ipk url)
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/vernesong/OpenClash/releases"

          tag="$(curl -sL "$api" | jq -r '.[0].tag_name' | head -n1 | tr -d '\r\n')"
          url="$(curl -sL "$api" | jq -r '.[0].assets[] | select(.name|test("^luci-app-openclash_.*_all\\.ipk$")) | .browser_download_url' | head -n1 | tr -d '\r\n')"

          echo "OpenClash tag=[$tag]"
          echo "OpenClash url=[$url]"

          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "ERROR: cannot find luci-app-openclash_*_all.ipk in latest release."
            curl -sL "$api" | jq -r '.[0].assets[].name'
            exit 1
          fi

          echo "OPENCLASH_TAG=$tag" >> "$GITHUB_ENV"
          echo "OPENCLASH_URL=$url" >> "$GITHUB_ENV"
          echo "OPENCLASH_NAME=$(basename "$url")" >> "$GITHUB_ENV"

      - name: Fetch latest Mihomo (tag + compatible gz url)
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"

          tag="$(curl -sL "$api" | jq -r '.tag_name' | head -n1 | tr -d '\r\n')"
          url="$(curl -sL "$api" | jq -r '.assets[].browser_download_url | select(test("mihomo-linux-amd64-compatible-";"i")) | select(endswith(".gz"))' | head -n1 | tr -d '\r\n')"

          echo "Mihomo tag=[$tag]"
          echo "Mihomo url=[$url]"

          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "ERROR: cannot find mihomo-linux-amd64-compatible-*.gz in latest release."
            echo "Available assets:"
            curl -sL "$api" | jq -r '.assets[].name'
            exit 1
          fi

          echo "MIHOMO_TAG=$tag" >> "$GITHUB_ENV"
          echo "MIHOMO_GZ_URL=$url" >> "$GITHUB_ENV"
          echo "MIHOMO_GZ_NAME=$(basename "$url")" >> "$GITHUB_ENV"

      - name: Download assets (fixed + versioned) and checksums
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

          # OpenClash ipk (versioned filename)
          curl -fL --retry 5 --retry-delay 2 "$OPENCLASH_URL" -o "dist/$OPENCLASH_NAME"

          # Mihomo: keep versioned gz + also provide fixed mihomo.gz and unpacked binary mihomo
          curl -fL --retry 5 --retry-delay 2 "$MIHOMO_GZ_URL" -o "dist/$MIHOMO_GZ_NAME"
          cp -f "dist/$MIHOMO_GZ_NAME" "dist/mihomo.gz"
          gzip -dc "dist/mihomo.gz" > "dist/mihomo"
          chmod +x "dist/mihomo"

          # Record upstream versions
          {
            echo "OPENCLASH_TAG=$OPENCLASH_TAG"
            echo "OPENCLASH_FILE=$OPENCLASH_NAME"
            echo "MIHOMO_TAG=$MIHOMO_TAG"
            echo "MIHOMO_GZ_FILE=$MIHOMO_GZ_NAME"
          } > "dist/UPSTREAM_VERSIONS.txt"

          (cd dist && sha256sum * > SHA256SUMS.txt)
          ls -lah dist

      - name: Publish/Update release (tag: latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Mirror: OpenClash + Mihomo"
          body: |
            Auto-updated mirror following upstream.

            Upstream:
            - OpenClash: ${OPENCLASH_TAG}  (${OPENCLASH_NAME})
            - Mihomo:    ${MIHOMO_TAG}  (${MIHOMO_GZ_NAME})

            Included:
            - OpenClash ipk (versioned filename)
            - Mihomo fixed: mihomo (binary) + mihomo.gz
            - Mihomo versioned: ${MIHOMO_GZ_NAME}
            - UPSTREAM_VERSIONS.txt + SHA256SUMS.txt
          files: |
            dist/*
          fail_on_unmatched_files: true

      - name: Publish archive release (tag: mirror-runid)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mirror-${{ github.run_id }}
          name: "Archive Mirror (run ${{ github.run_id }})"
          body: |
            Snapshot archive for this run.

            Upstream:
            - OpenClash: ${OPENCLASH_TAG}
            - Mihomo:    ${MIHOMO_TAG}
          files: |
            dist/*
          fail_on_unmatched_files: true
